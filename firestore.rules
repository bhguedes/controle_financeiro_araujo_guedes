rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Funções Auxiliares
    function isAuthenticated() { return request.auth != null; }
    
    // Verifica se o usuário é o dono do documento
    function isOwner(data) {
      return request.auth.uid == data.get('user_id', '') || 
             request.auth.uid == data.get('ownerId', '') || 
             request.auth.uid == data.get('owner_id', '');
    }
    
    // Verifica se o documento foi compartilhado com o usuário
    function isSharedWithMe(data) {
      return request.auth.uid in data.get('shared_with_uids', []);
    }

    // Usuários: Dono pode ler/escrever seu próprio perfil. 
    // Membros de uma mesma família podem ler o perfil uns dos outros.
    match /users/{userId} {
      allow read: if isAuthenticated(); // Necessário para a consulta de membros da família
      allow write: if isAuthenticated() && (
        request.auth.uid == userId ||
        (
          resource.data.family_id != null &&
          get(/databases/$(database)/documents/families/$(resource.data.family_id)).data.owner_id == request.auth.uid &&
          request.resource.data.family_id == null
        )
      );
    }
    
    // Famílias: Membros podem ler, Dono pode escrever, Convidados podem "entrar", Membros podem "sair"
    match /families/{familyId} {
      allow read: if isAuthenticated() && (request.auth.uid == resource.data.owner_id || request.auth.uid in resource.data.member_ids);
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        request.auth.uid == resource.data.owner_id || 
        (request.auth.uid in request.resource.data.member_ids && request.resource.data.member_ids.size() == resource.data.member_ids.size() + 1) ||
        (request.auth.uid in resource.data.member_ids && !(request.auth.uid in request.resource.data.member_ids) && request.resource.data.member_ids.size() == resource.data.member_ids.size() - 1)
      );
    }
    
    // Convites: Público para ler (validar código), Autenticado para criar/processar
    match /family_invitations/{invitationId} {
      allow read: if true; 
      allow write, create: if isAuthenticated();
    }

    // Contas Bancárias
    match /bank_accounts/{accountId} {
      allow read: if isAuthenticated() && (isOwner(resource.data) || isSharedWithMe(resource.data));
      allow write: if isAuthenticated() && (
        isOwner(resource.data) || 
        isSharedWithMe(resource.data) ||
        (request.auth.uid in request.resource.data.get('shared_with_uids', []) && 
         request.resource.data.get('shared_with_uids', []).size() == resource.data.get('shared_with_uids', []).size() + 1)
      );
      allow create: if isAuthenticated();
    }

    // Investimentos
    match /investments/{investmentId} {
      allow read: if isAuthenticated() && (isOwner(resource.data) || isSharedWithMe(resource.data));
      allow write: if isAuthenticated() && (
        isOwner(resource.data) || 
        isSharedWithMe(resource.data) ||
        (request.auth.uid in request.resource.data.get('shared_with_uids', []) && 
         request.resource.data.get('shared_with_uids', []).size() == resource.data.get('shared_with_uids', []).size() + 1)
      );
      allow create: if isAuthenticated();
    }

    // Receitas
    match /incomes/{incomeId} {
      allow read: if isAuthenticated() && (isOwner(resource.data) || isSharedWithMe(resource.data));
      allow write: if isAuthenticated() && isOwner(resource.data);
      allow create: if isAuthenticated();
    }

    // Cartões
    match /cards/{cardId} {
      allow read: if isAuthenticated() && (isOwner(resource.data) || isSharedWithMe(resource.data));
      allow write: if isAuthenticated() && (
        isOwner(resource.data) || 
        (request.auth.uid in request.resource.data.get('shared_with_uids', []) && 
         request.resource.data.get('shared_with_uids', []).size() == resource.data.get('shared_with_uids', []).size() + 1)
      );
      allow create: if isAuthenticated();
      
      match /users_assigned/{memberId} { 
        allow read, write: if isAuthenticated(); 
      }
    }

    // Transações
    match /transactions/{transactionId} {
      allow read: if isAuthenticated(); 
      allow write, create: if isAuthenticated();
    }
  }
}
