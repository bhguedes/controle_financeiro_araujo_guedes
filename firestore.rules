rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Funções Auxiliares
    function isSignedIn() {
      return request.auth != null;
    }

    // Dono do documento 
    // Usamos .get() aqui pois queries de igualdade (==) funcionam bem com values processados
    function isOwner(data) {
      return isSignedIn() && (
        data.get('user_id', '') == request.auth.uid || 
        data.get('ownerId', '') == request.auth.uid || 
        data.get('owner_id', '') == request.auth.uid ||
        data.get('user_id_criador', '') == request.auth.uid
      );
    }
    
    // Compartilhado com o usuário
    // IMPORTANTE: .hasAny() é frequentemente mais robusto para regras de lista que o operador 'in'
    // quando combinado com .get()
    // Compartilhado com o usuário
    function isShared(data) {
      return isSignedIn() && 
             data.get('shared_with_uids', []).hasAny([request.auth.uid]);
    }

    // --- REGRAS DE AUTO-INCLUSÃO (JOIN) ---
    // Permite que um usuário adicione a si mesmo em uma lista (ex: aceitar convite)
    function isSelfJoin(field) {
      let oldList = resource.data.get(field, []);
      let newList = request.resource.data[field];
      return isSignedIn() &&
             newList.size() == oldList.size() + 1 && // Apenas 1 adicionado
             newList.hasAll(oldList) && // Ninguém removido
             newList.hasAny([request.auth.uid]); // O adicionado sou eu
    }

    function canJoinFamily() {
       let diff = request.resource.data.diff(resource.data);
       return diff.affectedKeys().hasOnly(['member_ids', 'updated_at']) &&
              isSelfJoin('member_ids');
    }

    function canJoinShared() {
       let diff = request.resource.data.diff(resource.data);
       // Permite alterar 'is_shared' para true se estiver se adicionando
       return diff.affectedKeys().hasOnly(['shared_with_uids', 'updated_at', 'is_shared']) &&
              isSelfJoin('shared_with_uids');
    }

    // --- REGRAS POR COLEÇÃO ---

    match /users/{userId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && (
        request.auth.uid == userId ||
        (resource.data.family_id != null && get(/databases/$(database)/documents/families/$(resource.data.family_id)).data.owner_id == request.auth.uid)
      );
    }
    
    match /families/{familyId} {
      allow read: if isSignedIn() && (resource.data.owner_id == request.auth.uid || request.auth.uid in resource.data.member_ids);
      allow create: if isSignedIn();
      allow update: if isSignedIn() && (
        resource.data.owner_id == request.auth.uid || 
        request.auth.uid in resource.data.member_ids ||
        canJoinFamily() // Permite aceitar convite
      );
    }
    
    match /family_invitations/{invitationId} {
      allow read: if true; 
      allow write, create: if isSignedIn();
    }

    match /bank_accounts/{accountId} {
      allow read: if isSignedIn() && (isOwner(resource.data) || isShared(resource.data));
      allow write: if isSignedIn() && (isOwner(resource.data) || isShared(resource.data));
      allow update: if isSignedIn() && (
        isOwner(resource.data) || 
        isShared(resource.data) ||
        canJoinShared() // Permite aceitar convite
      );
      allow create: if isSignedIn();
    }

    match /investments/{investmentId} {
      allow read: if isSignedIn() && (isOwner(resource.data) || isShared(resource.data));
      allow write: if isSignedIn() && (isOwner(resource.data) || isShared(resource.data));
        allow update: if isSignedIn() && (
        isOwner(resource.data) || 
        isShared(resource.data) ||
        canJoinShared() // Permite aceitar convite
      );
      allow create: if isSignedIn();
    }

    match /incomes/{incomeId} {
      allow read: if isSignedIn() && (isOwner(resource.data) || isShared(resource.data));
      allow write: if isSignedIn() && isOwner(resource.data);
      allow create: if isSignedIn();
    }

    match /cards/{cardId} {
      allow read: if isSignedIn() && (isOwner(resource.data) || isShared(resource.data));
      allow write: if isSignedIn() && (isOwner(resource.data) || isShared(resource.data));
      allow update: if isSignedIn() && (
        isOwner(resource.data) || 
        isShared(resource.data) ||
        canJoinShared() // Permite aceitar convite
      );
      allow create: if isSignedIn();
      
      match /users_assigned/{memberId} { 
        allow read, write: if isSignedIn(); 
      }
    }

    match /transactions/{transactionId} {
      // Aberto para leitura pois o filtro é feito no código e securizado pelos IDs dos cartões
      allow read: if isSignedIn(); 
      allow write, create: if isSignedIn();
    }
  }
}